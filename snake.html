
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>말씀 스네이크 게임</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #121212;
      color: #ecf0f1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 500px;
    }

    canvas {
      background: #1e1e1e;
      border: 3px solid #f39c12;
      margin-top: 10px;
      width: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
    }

    h1, #verseTitle, #modeDisplay {
      color: #f1c40f;
      margin: 5px 0;
      text-align: center;
    }

    button {
      padding: 6px 15px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      background: #34495e;
      color: white;
      cursor: pointer;
      flex: 1;
      min-width: 0;
    }

    button:hover {
      background: #2c3e50;
    }

    .speed-select, .controls {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
    }

    #verse {
      margin-top: 10px;
      font-size: 20px;
      text-align: center;
    }

/* 현재 선택된 버튼 스타일 */
button.active-mode {
  background-color: #e67e22 !important;
}
  </style>
</head>
<body>

  <div class="container">
    <div id="verseTitle"></div>

    <div class="speed-select">
      <button onclick="setSpeed(400, '초보')">초보</button>
      <button onclick="setSpeed(250, '중수')">중수</button>
      <button onclick="setSpeed(150, '고수')">고수</button>
      <button onclick="setSpeed(80, '초인')">초인</button>
    </div>



    <canvas id="game" width="300" height="300"></canvas>

    <div class="controls">
      <button onclick="setDirection('up')">⬆️</button>
   <button onclick="setDirection('down')">⬇️</button>
      <button onclick="setDirection('left')">⬅️</button>   
      <button onclick="setDirection('right')">➡️</button>
    </div>

    <div id="verse"></div>
  </div>


  <script>
   const STORAGE_KEY_VERSES = 'savedVerses2';
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const gridSize = 10;

let verses = [];
let currentStage = 0;
let verseWords = [];
let wordIndex = 0;
let collectedWords = [];
let intervalId = null;
let currentSpeed = 400;

let snake = [{ x: 5, y: 5 }];
let dir = { x: 0, y: 0 };
let foods = [];

function setSpeed(speed, label, btnElement) {
  currentSpeed = speed;

  // 기존 타이머 클리어 후 새로 설정
  if (intervalId) clearInterval(intervalId);
  intervalId = setInterval(update, currentSpeed);

  // 모든 버튼에서 active-mode 클래스 제거
  document.querySelectorAll('#speedButtons button').forEach(btn => {
    btn.classList.remove('active-mode');
  });

  // 현재 선택된 버튼에 active-mode 클래스 추가
  btnElement.classList.add('active-mode');
}

function setDirection(d) {
  if (d === 'up' && dir.y !== 1) dir = { x: 0, y: -1 };
  if (d === 'down' && dir.y !== -1) dir = { x: 0, y: 1 };
  if (d === 'left' && dir.x !== 1) dir = { x: -1, y: 0 };
  if (d === 'right' && dir.x !== -1) dir = { x: 1, y: 0 };
}

function loadStage() {
  if (currentStage >= verses.length) {
    alert('👏 모든 말씀을 완료했습니다!');
    document.getElementById('verseTitle').innerText = '';
    document.getElementById('verse').innerText = '';
    if (intervalId) clearInterval(intervalId);
    return;
  }
  const verse = verses[currentStage];
  document.getElementById('verseTitle').innerText = `${verse.title}`;
  const cleanedText = verse.text.replace(/\[.*?\]/g, '').trim();
  verseWords = cleanedText.split(/\s+/).map(w => w.trim()).filter(w => w.length > 0);

  wordIndex = 0;
  collectedWords = [];
  resetSnake();
  placeFoods();
  draw();
}

function resetSnake() {
  snake = [{ x: 5, y: 5 }];
  dir = { x: 0, y: 0 };
  foods = [];
}

function placeFoods() {
  foods = [];
  const correctWord = verseWords[wordIndex];
  let distractWord = '';
  do {
    const rand = verseWords[Math.floor(Math.random() * verseWords.length)];
    if (rand !== correctWord) distractWord = rand;
  } while (distractWord === '');

  const placeWord = (word) => {
    let x, y;
    do {
      x = Math.floor(Math.random() * (canvas.width / gridSize));
      y = Math.floor(Math.random() * (canvas.height / gridSize));
    } while (snake.some(s => s.x === x && s.y === y) || foods.some(f => f.x === x && f.y === y));
    foods.push({ x, y, word });
  };

  placeWord(correctWord);
  placeWord(distractWord);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#2ecc71';
  for (let s of snake) {
    ctx.fillRect(s.x * gridSize, s.y * gridSize, gridSize, gridSize);
  }
  ctx.fillStyle = '#e74c3c';
  ctx.font = 'bold 14px Arial';

  for (let food of foods) {
    let textWidth = ctx.measureText(food.word).width;
    const padding = 5;
    let wordX = food.x * gridSize + padding;
    if (wordX + textWidth > canvas.width - padding) {
      wordX = canvas.width - textWidth - padding;
    }
    ctx.fillText(food.word, wordX, food.y * gridSize + 10);
  }
}

function update() {
  if (dir.x === 0 && dir.y === 0) return;
  const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

  if (head.x < 0 || head.y < 0 || head.x >= canvas.width / gridSize || head.y >= canvas.height / gridSize || snake.some(s => s.x === head.x && s.y === head.y)) {
    alert('게임 오버!');
    loadStage();
    return;
  }

  snake.unshift(head);

  const eatenIndex = foods.findIndex(f => f.x === head.x && f.y === head.y);
  if (eatenIndex !== -1) {
    const eaten = foods[eatenIndex];
    if (eaten.word === verseWords[wordIndex]) {
      collectedWords.push(eaten.word);
      wordIndex++;
      if (wordIndex >= verseWords.length) {
        document.getElementById('verse').innerText = '🎉 완성된 말씀: ' + collectedWords.join(' ');
        alert('말씀을 완성했습니다!');
        currentStage++;
        loadStage();
        return;
      }
      placeFoods();
    } else {
      alert('틀린 단어를 선택했습니다. 게임 오버!');
      loadStage();
      return;
    }
  } else {
    snake.pop();
  }

  draw();
}

document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem(STORAGE_KEY_VERSES);
  if (!saved) {
    alert('말씀 데이터가 없습니다. localStorage에 말씀을 저장해주세요.');
    return;
  }
  verses = JSON.parse(saved);
  setSpeed(400, '초보');
  loadStage();
});

canvas.addEventListener('touchstart', e => {
  const touch = e.touches[0];
  startX = touch.clientX;
  startY = touch.clientY;
});
canvas.addEventListener('touchend', e => {
  const touch = e.changedTouches[0];
  const dx = touch.clientX - startX;
  const dy = touch.clientY - startY;
  if (Math.abs(dx) > Math.abs(dy)) {
    dx > 0 ? setDirection('right') : setDirection('left');
  } else {
    dy > 0 ? setDirection('down') : setDirection('up');
  }
});

document.addEventListener('keydown', (e) => {
  switch (e.key) {
    case 'ArrowUp': setDirection('up'); break;
    case 'ArrowDown': setDirection('down'); break;
    case 'ArrowLeft': setDirection('left'); break;
    case 'ArrowRight': setDirection('right'); break;
  }
});

  </script>
</body>
</html>
